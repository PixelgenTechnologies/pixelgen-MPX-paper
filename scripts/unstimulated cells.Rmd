---
title: "Unstimulated PBMC analysis"
author: "Max Jonatan Karlsson"
date: "2023-05-08"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Setup

## Set directory

```{r}

knitr::opts_knit$set(root.dir = "C:/Users/Max/Documents/Pixelgen/Projects/2023-technical-manuscript/")

```


## Load packages 

```{r message=FALSE, warning=FALSE, include=TRUE}

# Framework packages
library(tidyverse)
library(Seurat)

# Visualization packages
library(patchwork)
library(viridis)
library(ggforce)
library(pheatmap)
library(plotly)
library(igraph)
library(tidygraph)
library(ggraph)
library(graphlayouts)
library(ggplotify)

# Statistics packages
library(ggpubr)
library(rstatix)
library(broom)

# Utility packages
library(pbapply)

source("scripts/utility.R")
source("scripts/theme.R")

```


## Manage data

First, we convert the .pxl AnnData files to Seurat format, so we can use the standard Seurat functions for data analysis.  

### Convert pxl Anndata files

```{r}
# The folders the data is located in:
data_folders <- 
  c("C:/Users/Max/data/pixelgen/PGseq95/0.12.0/analysis/")


# Create data frame containing data file information
data_files <-
  data_folders %>% 
  list.files(full.names = T,
             recursive = T) %>% 
  enframe("i", "filename") %>% 
  filter(str_detect(filename, "dataset.pxl$"))  %>% 
  mutate(dataset = str_extract(filename, "PGseq\\d{1,2}"),
         full_id = str_remove(filename, ".*\\/") %>% 
           str_remove("\\..*"),
         sample =  str_extract(full_id, "_S\\d_") %>% 
           str_remove_all("_"),
         rds_file = paste0(filename, ".rds")) %>% 
  filter(sample %in% paste0("S", 1:2))

# Save file meta data

data_files %>% 
  write_csv("results/unstimulated/data files.csv")

# Convert each .pxl AnnData file to Seurat and save an .rds file 
# that is easily loaded in R
for(i in 1:nrow(data_files)) {
  
  filename = data_files$filename[i]
  newfilename = data_files$rds_file[i]
  message(paste("Converting:", filename))
  
  if(file.exists(newfilename)) {
    message("Converted file already exists\n")
    next
  }
  
  convert_pixelgenh5_seuratrds(filename, newfilename)
}
```

### Define meta data

Create a data frame containing meta data. 

```{r}

# Create a meta data table from the data file information
meta_data <-
  data_files %>% 
  select(sample, dataset, full_id) %>% 
  mutate(replicate = paste0("r", 1:2))

# Save meta data
meta_data %>% 
  write_csv("results/unstimulated/unstimulated meta data.csv")


```


### AnnData file

The AnnData file is stored in the .dataset.pxl file, and we previously converted it to a Seurat object and saved it as .rds to make it easy to retrieve. 

```{r message=FALSE, warning=FALSE}
# AnnData
pg_data <- 
  data_files %>% 
  select(sample, rds_file) %>% 
  deframe() %>% 
  lapply(readRDS)
```

We extract the component meta data and put it in a separate data frame for easy access. 

```{r message=FALSE, warning=FALSE}
# Metrics
metrics_data <- 
  pg_data %>% 
  map(. %>% 
        {.@meta.data} %>% 
        as_tibble(rownames = "component")) %>% 
  bind_rows(.id = "sample")
```

### Edge list

The edge list contains the whole Molecular Pixelation graph, where each row corresponds to a unique read, and an edge in the bipartite graph. It has been used for previous stages such as multiplet recovery, polarization, and colocalization score calculations. 

```{r message=FALSE, warning=FALSE}
# Edgelists
edgelists <-
  data_files %>%
  with(set_names(filename, sample)) %>%
  pblapply(read_edgelist)
```

### Polarization and colocalization scores

The polarization and colocalization score files are tables of statistics calculated to estimate the spatial properties of markers in each individual component. 
The polarization score consists of Moran's I, which estimates the degree of non-random spatial distribution, where high score indicates more spatial structure. 
The colocalization scores consist of Jaccard index, and Pearson correlation, both calculated between pairs of markers, and across local neighborhoods of adjacent A pixels in each component. High score indicates colocalization of the two markers, while low score indicates that they do not have a spatial relationship.

```{r message=FALSE, warning=FALSE}
# Polarization & colocalization scores
loc_scores <-
  data_files %>%
  with(set_names(filename, sample)) %>%
  pblapply(read_pixeldata_item, items = c("colocalization", "polarization"))

```

## Analysis settings

```{r}

# Define some of the most important qc metrics for evaluating components
metrics_of_interest <- 
  c("edges", "antibodies", "umi_per_upia", "mean_reads")

# Define some filters for refining cell calling
component_filters <- 
  list(minimum_edges = 4000, 
       minimum_edge_rank = 11)



cell_palette <- 
  c("CD8 T cells" = "#4A6293",
    "CD4 T cells" = "#314169",
    "MAIT cells" = "#A6B2C8", 
    "NK cells" = "#04806D",
    "Monocytes" = "#E44C34", 
    "B cells" = "#83348C",
    "Dead cells" = "gray40")
```

# Quality Control

Here we perform a quality control of the called cells, i.e. the components that have been labeled as real cells. This entails a manual refinement of the cell calling based on measured cell size by number of edges (number of unique detected antibodies), as well as removal of technical outliers. 

## Edge rank plot

The edge rank plot is used to call cells in a previous cell calling step in Pixelator. Here, we inspect it again and apply additional filters to remove cells that deviate from the component size distribution.

In this plot, the used cutoffs are marked as dashed lines, and components that are deviating more than two standard deviations from the mean (number of edges) are marked in gray. 

```{r}
plot_data <- 
  metrics_data %>% 
  group_by(sample) %>% 
  mutate(rank = rank(-edges, ties.method = "random"), 
         mean_edges = mean(log10(edges)),
         sd_edges = sd(log10(edges)),
         edges_deviation = (log10(edges) - mean_edges) / sd_edges) %>% 
  left_join(meta_data,
            by = "sample") %>% 
  ungroup()

plot_data %>% 
  ggplot(aes(rank, edges, color = sample)) +
  geom_point(size = 0.5) +
  geom_hline(yintercept = component_filters$minimum_edges,
             linetype = "dashed") +
  geom_vline(xintercept = component_filters$minimum_edge_rank,
             linetype = "dashed") +
  # scale_y_log10() +
  scale_x_log10(breaks = c(1, 10, 100, 500)) +
  labs(x = "Component rank (by number of edges)",
       y = "Number of edges") +
  theme_pg() 

ggsave("results/unstimulated/edge rank plot.png",
       width = 7, height = 5)
ggsave("results/unstimulated/edge rank plot.png",
       width = 7, height = 5)
```



Here we make a table saving the information of which cells we want to keep for further analysis.

```{r}
called_cells <- 
  plot_data %>% 
  filter(edges >= component_filters$minimum_edges,
         rank >= component_filters$minimum_edge_rank)

cat(paste("Out of", nrow(plot_data), "cells,", nrow(called_cells), "were called."))

```

Here we plot the number of called cells per condition and replicate. The target of 500 cells is marked as a dashed line. 

```{r}


called_cells %>% 
  group_by(sample) %>% 
  count() %>% 
  left_join(meta_data,
            by = c("sample")) %>% 
  ggplot(aes(sample, n)) +
  geom_hline(yintercept = 500,
             linetype = "dashed") +
  geom_col(position = position_dodge()) +
  geom_text(aes(label = n),
            vjust = -0.5) +
  scale_y_continuous(expand = expansion(c(0, 0.1))) +
  theme_pg() +
  theme(panel.border = element_blank()) +
  labs(title = "Number of called cells")
ggsave("results/unstimulated/nbr called cells.png",
       width = 4, height = 3)
ggsave("results/unstimulated/nbr called cells.pdf",
       width = 4, height = 3)


```

## Inspect component metrics

### Metrics of interest

```{r}

metrics_data %>% 
  inner_join(called_cells %>% 
               select(sample, component),
             by = c("sample", "component")) %>% 
  select(1, 2, all_of(metrics_of_interest)) %>% 
  gather(metric, value, -1, -2) %>% 
  left_join(meta_data, 
            by = "sample") %>% 
  ggplot(aes(sample, value)) +
  geom_violin(draw_quantiles = 0.5, 
              fill = "gray") + 
  facet_grid(metric ~ ., scales = "free") +
  scale_y_log10() +
  theme_pg()
ggsave("results/unstimulated/metrics of interest violin.png",
       width = 10, height = 7)
ggsave("results/unstimulated/metrics of interest violin.pdf",
       width = 10, height = 7)



```

### Pixel content vs Marker specificity

Rarily, antibodies form aggregates, which manifest themselves as outliers in Molecular Pixelation data. These usually have either high complexity, consisting of many random antibodies, or low complexity, mainly constituting a single antibody. We detect these by using a metric Tau, which ranges from 0, indicating equal distribution of counts across all antibodies, to 1, indicating all counts distributed to a single antibody. Additionally, aggregates often have dense pixels with a lot of antibodies detected per each pixel, which can be measured using the umi_per_upia metric, which is stored in the component meta data.

Here we have plotted umi_per_upia against Tau, and colored each component by Pixelator's classification of Tau (low, normal, or high). It looks like Pixelator has accurately picked out a few outliers that might be antibody aggregates or components that has low specificity, binding many more different types of antibodies than we would expect from a normal cell. We will remove these from the analysis as well.  

```{r}
metrics_data %>% 
  inner_join(called_cells %>% 
               select(sample, component),
             by = c("sample", "component")) %>% 
  left_join(meta_data,
            by = c("sample")) %>% 
  ggplot(aes(tau, umi_per_upia, color = tau_type)) +
  geom_point() +
  theme_pg() +
  facet_grid(~ sample) +
  scale_y_log10() +
  scale_color_manual(values = c("high" = "orangered2", "low" = "skyblue3", "normal" = "gray")) +
  labs(x = "Marker specificity (Tau)",
       y = "Pixel content (UMI/UPIA)")
ggsave("results/unstimulated/tau vs pixel content.png",
       width = 12, height = 7)
ggsave("results/unstimulated/tau vs pixel content.pdf",
       width = 12, height = 7)


```

Here we save a data frame with the cells that are deemed normal. 

```{r}

cleaned_cells <-
  called_cells %>% 
  filter(tau_type == "normal")

cat(paste("Out of", nrow(called_cells), "cells,", nrow(cleaned_cells), "were kept"))
```

### Metrics for called cells

```{r}

plot_data <- 
  metrics_data %>% 
  inner_join(called_cells %>% 
               select(sample, component),
             by = c("sample", "component")) %>% 
  select(1, 2, all_of(c("edges", "umi_per_upia", "reads", "upia", "upib"))) %>% 
  gather(metric, value, -1, -2) %>% 
  mutate(metric = factor(metric, c("reads", "edges", "upia", "upib", "umi_per_upia"))) %>% 
  left_join(meta_data, 
            by = "sample") 
plot_meta <-
  plot_data %>% 
  group_by(metric) %>% 
  summarise(average = median((value)))

plot_data %>% 
  ggplot(aes(value)) +
  geom_histogram(aes(fill = replicate), 
                 position = position_identity(),
                 bins = 15,
                 alpha = 0.5) + 
  geom_vline(data = plot_meta,
             aes(xintercept = average),
             linetype = "dashed") +
  geom_text(data = plot_meta, 
            aes(average, 110, label = round(average, 1)),
            hjust = -0.1) +
  facet_wrap( ~ metric, scales = "free_x") +
  scale_x_log10() +
  scale_y_continuous(expand = expansion(c(0, 0.1))) +
  theme_pg() + 
  labs(x = "Value", 
       y = "Number of cells")

ggsave("results/unstimulated/metrics of called cells distribution.png",
       width = 10, height = 7)
ggsave("results/unstimulated/metrics of called cells distribution.pdf",
       width = 10, height = 7)

```




## Clean data

### Filter data

### Select features

Some markers are unused barcodes (named e.g. BC11 in the data). Let's select only markers we are using in the assay.

```{r}

marker_types <-
  pg_data$S2@assays$RNA %>% 
  rownames() %>% 
  enframe("i", "marker") %>% 
  mutate(marker_type = case_when(str_detect(marker, "^BC\\d") ~ "Empty BC",
                                 str_detect(marker, "^mIgG") ~ "Isotype ctrl",
                                 T ~ "Normal")) 

selected_features <-
  marker_types %>% 
  filter(marker_type != "Empty BC") %>% 
  pull(marker) 

selected_features %>% 
  sort() %>% 
  paste(collapse = ", ") %>% 
  cat()

pca_features <- 
  marker_types %>% 
  filter(marker_type == "Normal") %>% 
  filter(!marker %in% c("TCRb", "CD41", "CD9", "CD36", "CD29", "ACTB", "CD62P")) %>% 
  pull(marker)

```


### Remove cells and empty barcodes

Here we filter the data to only keep the cells we have selected, and the markers that we selected in the previous step. 

```{r}

keep_cells <- 
  cleaned_cells %>% 
  mutate(cell_id = paste(sample, component, sep = "_"))

# Merge Seurat objects 
pg_data_comb <- 
  merge(pg_data[[1]],
        y = pg_data[-1],
        add.cell.ids = names(pg_data)) 


# Keep only cells and features we have selected previously
pg_data_comb[["cell_id"]] <- colnames(pg_data_comb)

pg_data_comb <- 
  pg_data_comb %>% 
  subset(subset = cell_id %in% keep_cells$cell_id) %>% 
  subset(features = selected_features)

# Add some meta data directly to the Seurat object. We will need this later.
# Sample ID (e.g. S3)
pg_data_comb[["sample"]] <- str_remove(colnames(pg_data_comb), "_RCVCMP.*")

# Replicate
pg_data_comb[["replicate"]] <- meta_data$replicate[match(pg_data_comb$sample, meta_data$sample)]



```

### Isotype abundance

```{r}
plot_data <- 
  pg_data_comb@assays$RNA@counts %>% 
  sweep(2, apply(., 2, sum), "/") %>% 
  as_tibble(rownames = "marker") %>% 
  gather(sample_component, rel, -1) %>% 
  filter(str_detect(marker, "^mIg") | marker == "ACTB") 

plot_meta <- 
  plot_data %>% 
  group_by(marker) %>% 
  summarise(median = median(100*rel))

plot_data %>% 
  ggplot(aes(marker, 100 * rel)) +
  geom_violin(draw_quantiles = 0.5) +
  geom_text(data = plot_meta, 
            aes(y = median, label = paste(round(median, 2), "%")),
            nudge_x = 0.3,
            size = 2,
            hjust = 0) +
  theme_pg() +
  scale_y_continuous(limits = c(0, 3)) +
  labs(x = "Isotype marker",
       y = "% counts")
ggsave("results/unstimulated/Isotype abundance.png",
       width = 4, height = 4)
ggsave("results/unstimulated/Isotype abundance.pdf",
       width = 4, height = 4)

```

# Analysis (all cells)

## Select features

```{r}
selected_markers <- 
  pg_data_comb@assays$RNA@counts %>% 
  log1p() %>% 
  apply(MARGIN = 1, mean) %>% 
  exp() %>% 
  `-`(1) %>% 
  sort() %>% 
  enframe() %>% 
  mutate(selected = !(str_detect(name, "^mIg") | name == "TCRb"))

```


## Data processing


### Remove platelets and dead cells

```{r}
temp_data <- 
  pg_data_comb %>% 
  # CLR transform data: 
  NormalizeData(normalization.method = "LogNormalize")# %>%

VlnPlot(temp_data, features = "CD45") +
  geom_hline(yintercept = 6,
             linetype = "dashed")

VlnPlot(temp_data, features = "ACTB") +
  geom_hline(yintercept = 2.5,
             linetype = "dashed")

VlnPlot(temp_data, features = c("mIgG1")) +
  geom_hline(yintercept = 2.5,
             linetype = "dashed")

VlnPlot(temp_data, features = c("mIgG2a")) +
  geom_hline(yintercept = 4,
             linetype = "dashed")

VlnPlot(temp_data, features = c("mIgG2b")) +
  geom_hline(yintercept = 2.5,
             linetype = "dashed")


```


### Process data

```{r}

pg_data_comb_processed <-
  temp_data %>% 
  
  # Remove platelets
  subset(subset = CD45 > 6) %>% 
  # Remove possibly dead cells
  subset(subset = ACTB < 2.5) %>%
  subset(subset = mIgG1 < 2.5) %>%
  subset(subset = mIgG2a < 4) %>%
  subset(subset = mIgG2b < 2.5) %>%
  
  subset(features = selected_markers$name[which(selected_markers$selected)]) %>% 
  
  
  # clr transform data: 
  NormalizeData(normalization.method = "CLR", 
                margin = 2) %>%
  
  # AddMetaData(metadata = log10(.@meta.data$edges), col.name = 'logedges') %>% 
   
  # Find variable features
  FindVariableFeatures(nfeatures = 40, ) %>%
  
  ScaleData(scale.max = Inf, 
            do.scale = T, 
            do.center = T, 
            # vars.to.regress = c("logedges"),
            verbose = F) %>% 
  # RunPCA(npcs = 30) %>%
  # Remove platelet markers from PCA:
  RunPCA(npcs = 30, features = pca_features) %>%
  RunUMAP(umap.method = "uwot",
          min.dist = 0.1,
          spread = 2,
          n.neighbors = 25,
          dims = 1:12) 

VariableFeaturePlot(pg_data_comb_processed, selection.method = "vst") +
  geom_text(data = . %>% 
              as_tibble(rownames = "marker"),
            aes(label = marker, color = colors),
            size = 2,
            vjust = -0.5) +
  theme(plot.background = element_rect(fill = "white", color = NA))
ggsave("results/unstimulated/variable variance plot.png",
       width = 7, height = 4)
ggsave("results/unstimulated/variable variance plot.pdf",
       width = 7, height = 4)

# Visualize scaled data distribution: 
pg_data_comb_processed@assays$RNA@data %>% 
  as_tibble(rownames = "marker") %>% 
  gather(sample_component, scaled_value, -1) %>% 
  ggplot(aes(scaled_value)) +
  geom_density(fill = "gray", alpha = 0.2) +
  geom_vline(data = . %>% 
               summarise(scaled_value = mean(scaled_value)),
             aes(xintercept = scaled_value)) +
  theme_pg()

pg_data_comb_processed@assays$RNA@scale.data %>% 
  as_tibble(rownames = "marker") %>% 
  gather(sample_component, scaled_value, -1) %>% 
  ggplot(aes(scaled_value)) +
  geom_density(fill = "gray", alpha = 0.2) +
  geom_vline(data = . %>% 
               summarise(scaled_value = mean(scaled_value)),
             aes(xintercept = scaled_value)) +
  theme_pg()

pg_data_comb_processed@assays$RNA@scale.data %>% 
  as_tibble(rownames = "marker") %>% 
  gather(sample_component, scaled_value, -1) %>% 
  ggplot(aes(scaled_value, group = marker)) +
  geom_density(fill = "gray", alpha = 0.2) +
  theme_pg()


# Get umap coords
umap_data <- 
  pg_data_comb_processed@reductions$umap@cell.embeddings %>% 
  as_tibble(rownames = "sample_component") %>% 
  separate(sample_component, into = c("sample", "component"), remove = F) %>% 
  left_join(meta_data) %>% 
  left_join(metrics_data)


umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = sample)) +
  geom_point(size = 1) + 
  coord_fixed() +
  theme_umap()



umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = sample)) +
  geom_point(data = . %>% 
               select(-sample),
             color = "gray", 
             size = 0.5) + 
  geom_point(size = 1) + 
  coord_fixed() +
  facet_grid( ~ sample) +
  theme_umap()


# Control
FeaturePlot(pg_data_comb_processed, features = c("ACTB",
                                                 "HLA-ABC",
                                                 "B2M", 
                                                 "edges",
                                                 "umi_per_upia",
                                                 "tau",
                                                 "antibodies",
                                                 "reads"))


# T cells
FeaturePlot(pg_data_comb_processed, features = c("CD2", 
                                                 "CD3E",
                                                 "CD4",
                                                 "CD8",
                                                 "CD16",
                                                 "CD161"))


# Platelets
FeaturePlot(pg_data_comb_processed, features = c("CD41",
                                                 "CD9",
                                                 "CD36"))


# B cells
FeaturePlot(pg_data_comb_processed, features = c("CD20",
                                                 "CD19",
                                                 "CD40"))


# Monocytes
FeaturePlot(pg_data_comb_processed, features = c("CD11b",
                                                 "CD14",
                                                 "CD11c"))


```






## Add cell ID module score

Here we visualize the Seurat module scores of markers associated with certain cell types, as a check that we see the populations we expect and the clusters are pure. 

```{r}
pg_data_comb_processed <-
  pg_data_comb_processed %>% 
  AddModuleScore(features = list(c("CD19", "CD20", "CD40"),
                                 c("CD3E", "CD4", "CD8", "CD5", "CD2"),
                                 c("CD3E", "CD4"),
                                 c("CD3E", "CD8"),
                                 c("CD11b", "CD14", "CD11c"),
                                 c("CD41", "CD9", "CD36"),
                                 c("CD337", "CD2", "CD7", "CD161"),
                                 c("CD3E", "CD16", "CD161", "CD26")),
                 name = c("module_Bcells", 
                          "module_Tcells",
                          "module_CD4Tcells",
                          "module_CD8Tcells",
                          "module_Monocytes",
                          "module_Platelets",
                          "module_NKcells",
                          "module_MAIT"),
                 ctrl = 3) 


umap_data <- 
  pg_data_comb_processed@reductions$umap@cell.embeddings %>% 
  as_tibble(rownames = "sample_component") %>% 
  separate(sample_component, into = c("sample", "component"), remove = F) %>% 
  left_join(meta_data) %>% 
  left_join(pg_data_comb_processed@meta.data %>% 
              as_tibble(rownames = "sample_component"))

plot_data <- 
  umap_data %>%
  gather(module, module_score, matches("^module_")) %>% 
  mutate(module_i = str_extract(module, "\\d$"),
         module_cell_type = str_remove(module, "\\d$") %>% str_remove("module_")) 

plot_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = module_score)) +
  geom_point(size = 1) + 
  coord_fixed() +
  theme_umap() +
  facet_wrap(module_cell_type ~ .) +
  scale_color_gradientn(colours = rev(RColorBrewer::brewer.pal(11, "RdBu")),
                        limits = 4 * c(-1, 1))
ggsave("results/unstimulated/UMAP module scores.png",
       width = 8, height = 7)
ggsave("results/unstimulated/UMAP module scores.pdf",
       width = 8, height = 7)

plot_data %>% 
  group_by(sample_component, UMAP_1, UMAP_2) %>% 
  top_n(1, module_score) %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = module_cell_type)) +
  geom_point(size = 2) + 
  coord_fixed() +
  theme_umap() 



```

```{r}

umap_data <- 
  pg_data_comb_processed@reductions$umap@cell.embeddings %>% 
  as_tibble(rownames = "sample_component") %>% 
  separate(sample_component, into = c("sample", "component"), remove = F) %>% 
  left_join(meta_data) %>% 
  left_join(metrics_data)


umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = sample)) +
  geom_point(size = 1) + 
  coord_fixed() + facet_wrap(~sample) +
  theme_umap()
ggsave("results/unstimulated/UMAP sample.png",
       width = 4, height = 3)



umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = sample)) +
  geom_point(data = . %>% 
               select(-sample),
             color = "gray", 
             size = 0.5) + 
  geom_point(size = 0.1) + 
  coord_fixed() +
  facet_grid( ~ sample) +
  theme_umap()
ggsave("results/unstimulated/UMAP sample separated.png",
       width = 8, height = 5)


```


## Test UMAP settings

```{r}

# plot_umaps <-
#   # seq(6, 30, 3) %>%
#   c(5, 10, 15, 20, 25, 30) %>%
#   # seq(6, 12, 2) %>%
#   # c(0.5, 1, 1.5, 2, 3, 4) %>%
#   # c(0.1, 0.2, 0.3, 0.4) %>%
#   set_names(., .) %>%
#   lapply(function(npcs) {
# 
#     pg_data_comb_processed %>%
# 
#       RunUMAP(umap.method = "uwot",
#               min.dist = 0.1,
#               spread = 2,
#               n.neighbors = npcs,
#               dims = 1:12) %>%
#       {.@reductions$umap@cell.embeddings} %>%
#       as_tibble(rownames = "sample_component")
# 
#   }) %>%
#   bind_rows(.id = "npcs")
# 
# 
# 
# plot_umaps %>%
#   separate(sample_component, into = c("sample", "component"), remove = F) %>%
#   left_join(meta_data) %>%
#   left_join(metrics_data) %>%
#   mutate(npcs = as.numeric(npcs)) %>%
#   ggplot(aes(UMAP_1, UMAP_2, color = sample)) +
#   geom_point(size = 0.1) +
#   coord_fixed() +
#   facet_wrap(~npcs) +
#   theme_umap()
# 
# 
# plot_umaps %>%
#   separate(sample_component, into = c("sample", "component"), remove = F) %>%
#   left_join(meta_data) %>%
#   left_join(metrics_data) %>%
#   mutate(npcs = as.numeric(npcs), 
#          dc = sample_component %in% plot_cells) %>%
#   ggplot(aes(UMAP_1, UMAP_2, color = dc)) +
#   geom_point(size = 2) +
#   coord_fixed() +
#   facet_wrap(~npcs) +
#   theme_umap()

```



## Clustering

```{r}

for(res in seq(0.2, 2, 0.2)) {
  pg_data_comb_processed <-
    pg_data_comb_processed %>%
    FindNeighbors(dims = 1:12, k.param = 20, prune.SNN = 1/15,
                  n.trees = 100) %>%
    FindClusters(resolution = res,
                 method = "igraph",
                 n.start = 40,
                 algorithm = 2,
                 random.seed = 42)

}

clustree::clustree(pg_data_comb_processed)

pg_data_comb_processed <- 
  pg_data_comb_processed %>% 
  FindNeighbors(dims = 1:12, k.param = 20, prune.SNN = 1/15,
                n.trees = 100) %>% 
  FindClusters(resolution = 0.4, 
               method = "igraph",
               n.start = 40,
               algorithm = 2, 
               random.seed = 42)

umap_data <- 
  pg_data_comb_processed@reductions$umap@cell.embeddings %>% 
  as_tibble(rownames = "sample_component") %>% 
  separate(sample_component, into = c("sample", "component"), remove = F) %>% 
  left_join(meta_data) %>% 
  left_join(pg_data_comb_processed@meta.data %>% 
              as_tibble(rownames = "sample_component"))



umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2)) +
  geom_point(aes(color = seurat_clusters),
             size = 1,
             show.legend = F) + 
  geom_point(data = . %>% 
               group_by(seurat_clusters) %>% 
               summarise(UMAP_1 = median(UMAP_1),
                         UMAP_2 = median(UMAP_2)),
             size = 5,
             alpha = 0.5) +
  geom_text(data = . %>% 
              group_by(seurat_clusters) %>% 
              summarise(UMAP_1 = median(UMAP_1),
                        UMAP_2 = median(UMAP_2)),
            size = 3,
            aes(label = seurat_clusters), 
            color = "white") +
  coord_fixed() +
  scale_color_brewer(type = "qual") +
  theme_umap()
ggsave("results/unstimulated/cluster umap.png",
       width = 5, height = 5)
ggsave("results/unstimulated/cluster umap.pdf",
       width = 5, height = 5)

umap_data %>% 
  group_by(seurat_clusters) %>% 
  count() %>% 
  ggplot(aes(n, seurat_clusters)) +
  geom_col() +
  geom_text(aes(label = n), 
            hjust = 0) +
  theme_pg()


```

#### Find cluster identities

To annotate the resulting clusters, we use a wilcox test to gauge which markers are differentially abundant between the clusters. 

##### Differential Abundance analysis

```{r}
DE_cluster <- 
  pg_data_comb_processed %>% 
  SetIdent(value = "seurat_clusters") %>% 
  FindAllMarkers(slot = "counts", # Use the normalized data slot
                 min.pct = 0, 
                 test.use = "wilcox", 
                 logfc.threshold = 0, 
                 return.thresh = Inf,
                 max.cells.per.ident = 50) %>% 
  as_tibble() 

DE_cluster %>% 
  ggplot(aes(avg_log2FC, -log10(p_val_adj),
             color = p_val_adj < 0.01)) +
  geom_point() +
  theme_pg()

write_csv(DE_cluster, "results/unstimulated/ab wilcox test.csv")
```

Here is a heatmp showing the estimated log2 fold change between cluster and background. 

```{r, fig.width = 4, fig.height = 4}
plot_data <-
  DE_cluster %>% 
  group_by(gene) %>% 
  filter(any(p_val_adj < 0.01 & 
               abs(avg_log2FC) > 2)) %>% 
  select(avg_log2FC, cluster, gene) %>% 
  spread(cluster, avg_log2FC) %>% 
  column_to_rownames("gene")


rg <- max(abs(plot_data))


DE_cluster_heatmap <- 
  plot_data %>% 
  pheatmap(breaks = seq(-rg, rg, length.out = 100),
           color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 11, 
                                                                 name = "RdBu")))(100), 
           cellwidth = 10, 
           cellheight = 10)

ggsave("results/unstimulated/cluster DE avg_diff heatmap.png",
       plot = as.ggplot(DE_cluster_heatmap) +
         theme(plot.background = element_rect(fill = "white", color = NA)),
       width = 5, height = 10)
ggsave("results/unstimulated/cluster DE avg_diff heatmap.pdf",
       plot = as.ggplot(DE_cluster_heatmap) +
         theme(plot.background = element_rect(fill = "white", color = NA)),
       width = 5, height = 10)


plot_markers <- 
  DE_cluster %>% 
  group_by(gene) %>% 
  filter(any(p_val_adj < 0.01 & 
               abs(avg_log2FC) > 2)) %>% 
  pull(gene) %>% 
  unique()

plot_data <- 
  GetAssayData(pg_data_comb_processed) %>% 
  as_tibble(rownames = "marker") %>% 
  gather(sample_component, clr, -1) %>% 
  left_join(pg_data_comb_processed[[]] %>% 
              as_tibble(rownames = "sample_component") %>% 
              select(sample_component, seurat_clusters)) %>% 
  left_join(cell_annotation,
            by = c("seurat_clusters" = "cluster")) %>% 
  group_by(marker) %>% 
  mutate(z_score = (clr - mean(clr)) / sd(clr)) %>% 
  group_by(cell_type, marker) %>% 
  summarise(z_score = mean(z_score)) %>% 
  filter(marker %in% plot_markers) %>% 
  spread(marker, z_score) %>% 
  
  column_to_rownames("cell_type")


rg <- max(abs(plot_data))


DE_cluster_heatmap2 <- 
  plot_data %>% 
  pheatmap(breaks = seq(-rg, rg, length.out = 100),
           color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 11, 
                                                                 name = "RdBu")))(100), 
           cellwidth = 10, 
           cellheight = 10)

ggsave("results/unstimulated/cluster DE avg_diff heatmap2.png",
       plot = as.ggplot(DE_cluster_heatmap2) +
         theme(plot.background = element_rect(fill = "white", color = NA)),
       width = 10, height = 5)
ggsave("results/unstimulated/cluster DE avg_diff heatmap2.pdf",
       plot = as.ggplot(DE_cluster_heatmap2) +
         theme(plot.background = element_rect(fill = "white", color = NA)),
       width = 10, height = 5)


DE_cluster %>% 
    group_by(gene) %>% 
    filter(p_val_adj < 0.01 & 
             abs(avg_log2FC) > 2) %>% 
  group_by(cluster) %>% 
  count()
```

Now finally, let's denote our interpretation of this heatmap as cell identities.

```{r, fig.width = 4, fig.height = 5}
# paste0("'", with(DE_cluster_heatmap$tree_col, labels[order]),
#        "' = ''", collapse = ",\n") %>%
#   cat()

cell_annotation <- 
  c('2' = 'B cells',
    '5' = 'Monocytes',
    '4' = 'NK cells',
    '0' = 'CD4 T cells',
    '1' = 'CD4 T cells',
    '3' = 'CD8 T cells',
    '6' = 'MAIT cells') %>% 
  enframe("cluster", "cell_type_name") %>% 
  mutate(cell_type = paste(cluster, cell_type_name))

plot_data <-
  DE_cluster %>% 
  group_by(gene) %>% 
  filter(any(p_val_adj < 0.01 & 
               abs(avg_log2FC) > 2)) %>% 
  left_join(cell_annotation) %>% 
  select(avg_log2FC, cell_type, gene) %>% 
  spread(cell_type, avg_log2FC) %>% 
  column_to_rownames("gene")


rg <- max(abs(plot_data))


DE_cluster_heatmap_annotated <- 
  plot_data %>% 
  pheatmap(breaks = seq(-rg, rg, length.out = 100),
           color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 11, 
                                                                 name = "RdBu")))(100), 
           cellwidth = 10, 
           cellheight = 10)


ggsave("results/unstimulated/cluster DE avg_diff heatmap annotated.png",
       plot = as.ggplot(DE_cluster_heatmap_annotated),
       width = 5, height = 7)
ggsave("results/unstimulated/cluster DE avg_diff heatmap annotated.pdf",
       plot = as.ggplot(DE_cluster_heatmap_annotated),
       width = 5, height = 7)

DE_cluster_heatmap_annotated_t <- 
  plot_data %>% 
  t() %>% 
  pheatmap(breaks = seq(-rg, rg, length.out = 100),
           color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 11, 
                                                                 name = "RdBu")))(100), 
           cellwidth = 10, 
           cellheight = 10)


ggsave("results/unstimulated/cluster DE avg_diff heatmap annotated 2.png",
       plot = as.ggplot(DE_cluster_heatmap_annotated_t),
       width = 8, height = 7)
ggsave("results/unstimulated/cluster DE avg_diff heatmap annotated 2.pdf",
       plot = as.ggplot(DE_cluster_heatmap_annotated_t),
       width = 8, height = 7)

VlnPlot(pg_data_comb_processed, features = "CD11c", slot = "counts", assay = "RNA")
VlnPlot(pg_data_comb_processed, features = "CD14", slot = "counts", assay = "RNA")
VlnPlot(pg_data_comb_processed, features = "CD4", slot = "counts", assay = "RNA")
VlnPlot(pg_data_comb_processed, features = "CD8", slot = "counts", assay = "RNA")
VlnPlot(pg_data_comb_processed, features = "CD3E", slot = "counts", assay = "RNA")
VlnPlot(pg_data_comb_processed, features = "CD45")
VlnPlot(pg_data_comb_processed, features = "CD161", slot = "counts", assay = "RNA")
VlnPlot(pg_data_comb_processed, features = c("CD16", "CD161", "CD26", "CD8"))

cell_annotation

```

##### Define identities

Let's save those cell identities. 

```{r}

component_identities <- 
  pg_data_comb_processed@meta.data %>% 
  as_tibble(rownames = "sample_component") %>% 
  select(sample_component, cluster = seurat_clusters) %>% 
  left_join(cell_annotation,
            by = "cluster") %>% 
  separate(sample_component, into = c("sample", "component"), remove = F)


component_identities %>% 
  left_join(meta_data,
            by = c("sample")) %>% 
  write_csv("results/unstimulated/cell annotations.csv")


component_identities %>% 
  group_by(sample, cell_type_name) %>% 
  count() %>%
  ungroup() %>% 
  left_join(meta_data) %>% 
  arrange(-n) %>% 
  mutate(cell_type_name = factor(cell_type_name, unique(cell_type_name))) %>% 
  ggplot(aes(cell_type_name, n, group = replicate, fill = cell_type_name)) +
  geom_col(position = position_dodge(width = 0.95)) +
  scale_fill_manual(values = cell_palette) +
  theme_pg() +
  scale_y_continuous(expand = expansion(c(0, 0.05))) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
ggsave("results/unstimulated/cell type freq.png",
       width = 6, height = 3)



component_identities %>% 
  group_by(sample, cell_type_name) %>% 
  count() %>%
  group_by(sample) %>% 
  mutate(freq = 100* n / sum(n)) %>% 
  ungroup() %>% 
  left_join(meta_data) %>% 
  arrange(n) %>% 
  mutate(cell_type_name = factor(cell_type_name, 
                                 rev(c("CD4 T cells",
                                       "CD8 T cells",
                                       "MAIT cells",
                                       "NK cells",
                                       "B cells",
                                       "Monocytes")))) %>% 
  ggplot(aes(freq, replicate, fill = cell_type_name)) +
  geom_col(show.legend = F) +
  geom_text(aes(label = paste(round(freq, 1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white",
            angle = -90,
            size = 2) +
  scale_fill_manual(values = cell_palette) +
  theme_pg() +
  scale_x_continuous(expand = expansion(0)) +
  scale_y_discrete(expand = expansion(0)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = "% of cells",
       y = "Replicate")
ggsave("results/unstimulated/cell type freq2.png",
       width = 80, height = 40, units = "mm")
ggsave("results/unstimulated/cell type freq2.pdf",
       width = 80, height = 40, units = "mm")


component_identities %>% 
  group_by(cell_type_name) %>% 
  count() %>%
  ungroup() %>% 
  mutate(freq = 100* n / sum(n)) 
```


##### Visualize Differentially abundant markers

Just for our own interest, let's take a look at some of the differentially abundant markers, each cell's abundance projected upon the UMAP.

```{r, fig.width = 6, fig.height = 6}

plot_markers <- 
  DE_cluster %>% 
  filter(abs(avg_log2FC) > 2,
         p_val < 0.01) %>% 
  pull(gene) %>% 
  unique()

plot_data <- 
  umap_data %>% 
  left_join(pg_data_comb_processed@assays$normalized_clr@counts %>% 
              as_tibble(rownames = "marker") %>% 
              gather(sample_component, clr, -1)) %>% 
  filter(marker %in% c(plot_markers)) %>% 
  group_by(marker) %>% 
  mutate(clr_rel = clr / max(clr)) 

plot_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = clr_rel)) +
  geom_point(size = 0.1) + 
  facet_wrap(~marker) +
  scale_color_viridis() +
  coord_fixed() +
  theme_umap()
ggsave("results/unstimulated/UMAP some markers clr.png",
       width = 8, height = 6)


umap_data %>% 
   left_join(pg_data_comb_processed@assays$RNA@data %>% 
              as_tibble(rownames = "marker") %>% 
              gather(sample_component, clr, -1)) %>% 
  filter(marker %in% c("CD3E", "CD4", "CD8", "CD19", "CD11c", "CD2")) %>% 
  group_by(marker) %>% 
  mutate(clr_rel = clr / max(clr)) %>% 
  
  ggplot(aes(UMAP_1, UMAP_2, color = clr_rel)) +
  geom_point(size = 0.1) + 
  facet_wrap(~marker) +
  scale_color_viridis(name = "Relative abundance") +
  coord_fixed() +
  theme_umap()
ggsave("results/unstimulated/UMAP some markers clr 2.png",
       width = 8, height = 6)

ggsave("results/unstimulated/UMAP some markers clr 2.pdf",
       width = 8, height = 6)

```


##### Plot cells with annotation

And here is the UMAP along with annotations. 

```{r}
umap_data <- 
  pg_data_comb_processed@reductions$umap@cell.embeddings %>% 
  as_tibble(rownames = "sample_component") %>% 
  separate(sample_component, into = c("sample", "component"), remove = F) %>% 
  left_join(meta_data) %>% 
  left_join(pg_data_comb_processed@meta.data %>% 
              as_tibble(rownames = "sample_component")) %>% 
  mutate(cluster = seurat_clusters) %>% 
  left_join(cell_annotation)

umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = cell_type_name)) +
  geom_point(size = 1) + 
  coord_fixed() +
  theme_umap() +
  scale_color_manual(values = cell_palette)
ggsave("results/unstimulated/UMAP cells annotated.png",
       width = 8, height = 6)
ggsave("results/unstimulated/UMAP cells annotated.pdf",
       width = 8, height = 6)



umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = cell_type_name)) +
  geom_mark_ellipse(data = . %>% 
                   group_by(cell_type_name) %>% 
                   mutate(centroid_UMAP_1 = median(UMAP_1),
                          centroid_UMAP_2 = median(UMAP_2), 
                          dist = sqrt((UMAP_1 - centroid_UMAP_1)^2 +
                                        (UMAP_2 - centroid_UMAP_2)^2),
                          distrank = rank(dist) / length(dist)) %>% 
                   filter(distrank < 0.8),
                 aes(fill = cell_type_name, 
                     label = cell_type_name),
                 color = NA,
                 # fill = NA,
                 expand = unit(4, "mm")) +
  # geom_mark_ellipse(aes(group = seurat_clusters,
  #                       label = cell_type_name),
  #                   color = NA,
  #                   fill = NA,
  #                   # expand = 0,
  #                   label.fontsize = 8) +
  geom_point(size = 1) + 
  
  geom_point(data = . %>% 
               group_by(cell_type_name, seurat_clusters) %>% 
               summarise(UMAP_1 = median(UMAP_1),
                         UMAP_2 = median(UMAP_2)),
             size = 5,
             alpha = 0.5) +
  geom_text(data = . %>% 
              group_by(cell_type_name, seurat_clusters) %>% 
              summarise(UMAP_1 = median(UMAP_1),
                        UMAP_2 = median(UMAP_2)),
            size = 3,
            aes(label = seurat_clusters), 
            color = "white") +
  
  coord_fixed() +
  theme_umap() +
  scale_color_manual(values = cell_palette)  +
  scale_fill_manual(values = cell_palette) +
  scale_x_continuous(expand = expansion(c(0.2, 0.2))) +
  scale_y_continuous(expand = expansion(c(0.2, 0.2))) 

ggsave("results/unstimulated/UMAP cells annotated 2.png",
       width = 8, height = 6)
ggsave("results/unstimulated/UMAP cells annotated 2.pdf",
       width = 8, height = 6)

```

## Visualization

### Create layouts 

```{r}


library(multidplyr)

cluster <- new_cluster(5)
cluster_library(cluster, 
                c("dplyr",
                  "tidyr",
                  "tibble"))
cluster_copy(cluster, 
             c("get_component_layout",
               "create_node_markers_counts",
               "edgelist_to_simple_Anode_graph",
               "edgelist_to_simple_bipart_graph",
               "map",
               "write_rds"))



  


edgelists %>%
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  group_by(sample_component) %>% 
  partition(cluster) %>% 
  do({
    comp <- .
    
    comp_name <- unique(comp$sample_component)
    
    component_path <- paste0("data/layouts/unstim_pmds100_3D_", comp_name, ".rds")
    if(!file.exists(component_path)) {
      
      layt <- 
        comp %>% 
        get_component_layout(layout_method = "pmds", dim = 3, pivots = 100) 
      
      write_rds(layt, component_path)
    }
    
    tibble()
  }) %>% 
  collect()
  
edgelists %>%
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  group_by(sample_component) %>% 
  partition(cluster) %>% 
  do({
    comp <- .
    
    comp_name <- unique(comp$sample_component)
    
    component_path <- paste0("data/layouts/unstim_pmds100n1_3D_", comp_name, ".rds")
    if(!file.exists(component_path)) {
      
      layt <- 
        comp %>% 
        get_component_layout(layout_method = "pmds", dim = 3, k = 1, pivots = 100) 
      
      write_rds(layt, component_path)
    }
    
    tibble()
  }) %>% 
  collect()
  


edgelists %>%
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  group_by(sample_component) %>% 
  partition(cluster) %>% 
  do({
    comp <- .
    
    comp_name <- unique(comp$sample_component)
    
    component_path <- paste0("data/layouts/unstim_pmds100weighted_3D_", comp_name, ".rds")
    if(!file.exists(component_path)) {
      
      layt <- 
        comp %>% 
        get_component_layout(layout_method = "pmds", dim = 3, pivots = 100, weighted = T) 
      
      write_rds(layt, component_path)
    }
    
    tibble()
  }) %>% 
  collect()
  

rm(cluster)
gc()


# 
# component_3Dlayouts_pmds <-
#   colnames(pg_data_comb_processed) %>%
#   set_names(., .) %>% # Set names of vector to get named output list
#   pblapply(function(comp) {
#     component_path <- paste0("data/layouts/unstim_pmds100_3D_", comp, ".rds")
#     
#     layt <- read_rds(component_path)
#     
#     layt$graph <- NA
#     
#     return(layt)
#     
#   })

# 
# component_3Dlayouts_pmds <-
#   colnames(pg_data_comb_processed) %>%
#   set_names(., .) %>% # Set names of vector to get named output list
#   pblapply(function(comp) {
#     component_path <- paste0("data/layouts/unstim_pmds100n1_3D_", comp, ".rds")
# 
#     layt <- read_rds(component_path)
# 
#     layt$graph <- NA
# 
#     return(layt)
# 
#   })


component_3Dlayouts_pmds <-
  edgelists %>%
  map(. %>% 
        select(component) %>% 
        distinct()) %>% 
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  pull(sample_component) %>% 
  set_names(., .) %>% # Set names of vector to get named output list
  pblapply(function(comp) {
    component_path <- paste0("data/layouts/unstim_pmds100weighted_3D_", comp, ".rds")

    layt <- read_rds(component_path)

    layt$graph <- NA

    return(layt)

  })
```



### Visualize a few cells

```{r}


plot_components <- 
  c("S1_RCVCMP0000215",
    "S1_RCVCMP0000231",
    "S1_RCVCMP0000240",
    "S1_RCVCMP0000278") 

plot_data <- 
  component_3Dlayouts_pmds %>% 
  map(. %>% 
        {.$layout}) %>% 
  bind_rows(.id = "sample_component") %>%
  arrange(z) %>% 
  left_join(plot_counts)  %>% 
  
  filter(sample_component %in% plot_components) %>% 
  group_by(sample_component, upi, node_type,
           x, y, z) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(norm_factor = 
           select(., x, y, z) %>% 
           apply(MARGIN = 1, function(x) {
             as.matrix(x) %>% 
               norm(type = "F")
           }),
         x_norm = x / norm_factor,
         y_norm = y / norm_factor,
         z_norm = z / norm_factor) %>% 
  arrange(z) 


plot_data %>% 
  filter(node_type == "A") %>% 
  ggplot(aes(x, y,  color = log10(count))) +
  geom_point() +
  facet_wrap(~ sample_component) +
  coord_fixed() +
  theme_void()

plot_edgelist <- 
  edgelists$S1 %>% 
  filter(component %in% str_remove(plot_components, "S1_"))  %>% 
  select(upia, upib, sample_component = component) %>% 
  distinct()

plot <- 
  plot_edgelist %>% 
  mutate(sample_component = paste0("S1_", sample_component),
         upia = paste(upia, sample_component),
         upib = paste(upib, sample_component)) %>% 
  as_tbl_graph() %>% 
  mutate(sample_component = str_remove(name, ".* "),
         upi = str_remove(name, " .*")) %>% 
  left_join(plot_data) %>% 
  select(-x, -y) %>% 
  rename(x = x_norm, y = y_norm) %>% 
  ggraph(layout = "manual", 
         x = .$x,
         y = .$y) +
  geom_edge_link(color = "gray60",
                 alpha = 0.3,
                 width = 0.3) +
  geom_node_point(alpha = 0.2,
                  size = 0.3) +
  facet_wrap(~ sample_component) +
  coord_fixed() +
  theme_void()
ggsave("results/unstimulated/Visualized single examples.png",
       plot = plot,
       width = 7, height = 3)
ggsave("results/unstimulated/Visualized single examples.pdf",
       plot = plot,
       width = 7, height = 3)



plot <- 
  plot_edgelist %>% 
  mutate(sample_component = paste0("S1_", sample_component),
         upia = paste(upia, sample_component),
         upib = paste(upib, sample_component)) %>% 
  as_tbl_graph() %>% 
  mutate(sample_component = str_remove(name, ".* "),
         upi = str_remove(name, " .*")) %>% 
  left_join(plot_data) %>% 
  ggraph(layout = "manual", 
         x = .$x,
         y = .$y) +
  geom_edge_link(color = "gray60",
                 alpha = 0.3,
                 width = 0.3) +
  geom_node_point(alpha = 0.2,
                  size = 0.3) +
  facet_wrap(~ sample_component) +
  coord_fixed() +
  theme_void()
ggsave("results/unstimulated/Visualized single examples raw.png",
       plot = plot,
       width = 7, height = 3)
ggsave("results/unstimulated/Visualized single examples raw.pdf",
       plot = plot,
       width = 7, height = 3)


plot <- 
  plot_edgelist %>% 
  mutate(sample_component = paste0("S1_", sample_component),
         upia = paste(upia, sample_component),
         upib = paste(upib, sample_component)) %>% 
  filter(sample_component == "S1_RCVCMP0000240") %>% 
  distinct() %>% 
  as_tbl_graph() %>% 
  mutate(sample_component = str_remove(name, ".* "),
         upi = str_remove(name, " .*")) %>% 
  left_join(plot_data) %>% 
  ggraph(layout = "manual", 
         x = .$x,
         y = .$y) +
  geom_node_point(data = . %>% 
                    filter(z < 0) %>% 
                    arrange(z), 
                  aes(size = z,
                      color = z),
                  alpha = 0.8) +
  geom_edge_link(color = "gray30",
                 alpha = 0.3,
                 width = 0.1) +
  geom_node_point(data = . %>% 
                    filter(z >= 0) %>% 
                    arrange(z), 
                  aes(size = z,
                      color = z),
                  alpha = 0.8) +
  facet_wrap(~ sample_component) +
  scale_size_continuous(range = c(0.1, 2.5)) +
  scale_color_gradient(low = "gray10", high = "gray100") +
  coord_fixed() +
  theme_void() +
  theme(panel.background = element_rect(fill = "white"))
ggsave("results/unstimulated/Visualized single examples raw 240.png",
       plot = plot,
       width = 5, height = 5)
ggsave("results/unstimulated/Visualized single examples raw 240.pdf",
       plot = plot,
       width = 5, height = 5)



```



## BT doublet detection

```{r}
colocalization_scores <- 
  loc_scores %>% 
  map(. %>% 
        {.$colocalization}) %>% 
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component, remove = F) %>% 
  filter(sample_component %in% colnames(pg_data_comb_processed))

polarity_scores <- 
  loc_scores %>% 
  map(. %>% 
        {.$polarization}) %>% 
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component, remove = F) %>% 
  filter(sample_component %in% colnames(pg_data_comb_processed))



GetAssayData(pg_data_comb_processed, slot = "data") %>% 
  t() %>% 
  as_tibble(rownames = "sample_component") %>% 
  left_join(colocalization_scores %>% 
              filter(marker_1 == "CD20", marker_2 == "CD3E"))  %>% 
  mutate(pearson_z = ifelse(is.na(pearson_z), 0, pearson_z)) %>% 
  ggplot(aes(CD3E, CD20, size = -pearson_z, color = pearson_z)) +
  geom_point() +
  scale_color_gradient2(low = "orangered", mid = "gray90", high = "gray90") +
  scale_size(range = c(0.5, 3)) +
  theme_bw() +
  coord_fixed()
ggsave("results/unstimulated/CD3 CD20 doublet scatter.png",
       width = 8, height = 6)
ggsave("results/unstimulated/CD3 CD20 doublet scatter.pdf",
       width = 8, height = 6)

GetAssayData(pg_data_comb_processed, slot = "data") %>% 
  t() %>% 
  as_tibble(rownames = "sample_component") %>% 
  left_join(polarity_scores %>% 
              filter(marker %in% c("CD20", "CD3E")))  %>% 
  mutate(morans_i = ifelse(is.na(morans_i), 0, morans_i)) %>%
  ggplot(aes(CD3E, CD20, color = morans_i)) +
  geom_point() +
  scale_color_gradient2(low = "gray", mid = "gray90", high = "orangered") +
  facet_wrap(~marker) +
  theme_bw() +
  coord_fixed()




```

### Gate cells

```{r}


cell_gates <- 
  c(CD3E = 0.8,
    CD19 = 0.45)


gate_data <- 
  GetAssayData(pg_data_comb_processed) %>%
  as_tibble(rownames = "marker") %>% 
  gather(sample_component, clr, -1) %>% 
  inner_join(cell_gates %>% 
               enframe("marker", "limit"))

gate_data %>% 
  ggplot(aes(clr)) +
  geom_histogram(bins = 50) +
  geom_vline(data = cell_gates %>% 
              enframe("marker", "limit"),
             aes(xintercept = limit),
             linetype = "dashed") +
  facet_grid(marker~ . ,
             scales = "free") +
  theme_pg()
ggsave("results/unstimulated/BT gates.png",
       width = 3, height = 4)
ggsave("results/unstimulated/BT gates.pdf",
       width = 3, height = 4)


BT_filtered_data <- 
  pg_data_comb_processed %>% 
  subset(subset = CD3E > 0.8 | 
           CD19 > 0.45)


some_T_markers <- 
  c("CD2", "CD3E",
    "CD5", "CD7")
some_B_markers <-
  c("CD40", "CD20", "CD19")

plot_colors <- 
  RColorBrewer::brewer.pal(5, name = "RdBu") %>% 
  rev()
expand_grid(marker_1 = c(some_B_markers, some_T_markers),
            marker_2 = c(some_B_markers, some_T_markers)) %>% 
  left_join(GetAssayData(BT_filtered_data, slot = "data") %>% 
              t() %>% 
              as_tibble(rownames = "sample_component") %>% 
              gather(marker, clr, -1),
            by = c("marker_1" = "marker")) %>% 
  left_join(GetAssayData(BT_filtered_data, slot = "data") %>% 
              t() %>% 
              as_tibble(rownames = "sample_component") %>% 
              gather(marker, clr, -1),
            by = c("sample_component", "marker_2" = "marker"),
            suffix = c("1", "2")) %>% 
  left_join(colocalization_scores %>% 
              filter(marker_1 %in% c(some_B_markers, some_T_markers),
                     marker_2 %in% c(some_B_markers, some_T_markers)) %>% 
              mutate(temp_marker = ifelse(marker_2 %in% some_T_markers,
                                          marker_1,
                                          marker_2),
                     marker_1 = ifelse(marker_1 %in% some_T_markers,
                                       marker_1,
                                       marker_2),
                     marker_2 = ifelse(marker_2 %in% some_T_markers,
                                       temp_marker,
                                       marker_2))) %>% 
  mutate(pearson_z = ifelse(is.na(pearson_z), 0, pearson_z),
         pearson_z = ifelse(pearson_z < -40, -40, pearson_z),
         size = ifelse(pearson_z > 0, 0, -pearson_z),
         marker_1 = factor(marker_1, some_T_markers),
         marker_2 = factor(marker_2, some_B_markers)) %>%
  filter(complete.cases(.)) %>% 
  ggplot(aes(clr1, clr2, color = pearson_z)) +
  geom_point(aes(size = size),
             alpha = 0.8) +
  scale_color_gradient2(low = plot_colors[1:2], 
                        mid = "gray90", 
                        high = plot_colors[4:5],
                        limits = c(-40, 20),
                        breaks = c(-40, -20, 0, 20)) +
  scale_size_continuous(range = c(0.3, 1.5),
                        limits = c(0, 40),
                        breaks = c(0, 20, 40)) +
  facet_grid(marker_2 ~ marker_1, scales = "free") +
  theme_bw() +
  theme(panel.grid = element_blank())
ggsave("results/unstimulated/gated BT doublet scatter 2.png",
       width = 9, height = 6)
ggsave("results/unstimulated/gated BT doublet scatter 2.pdf",
       width = 9, height = 6)

plot_data <- 
  colocalization_scores %>% 
  filter(sample_component %in% colnames(BT_filtered_data)) %>% 
  filter(marker_1 %in% c(some_B_markers, some_T_markers),
         marker_2 %in% c(some_B_markers, some_T_markers)) %>% 
  mutate(temp_marker = ifelse(marker_2 %in% some_T_markers,
                              marker_1,
                              marker_2),
         marker_1 = ifelse(marker_1 %in% some_T_markers,
                           marker_1,
                           marker_2),
         marker_2 = ifelse(marker_2 %in% some_T_markers,
                           temp_marker,
                           marker_2)) %>%
  filter(marker_1 != marker_2) %>% 
  unite(contrast, marker_1, marker_2, sep = "/") %>% 
  select(contrast, sample_component, pearson_z) %>% 
  mutate(pearson_z = ifelse(pearson_z < -40, -40, pearson_z)) %>%
  spread(contrast, pearson_z, fill = 0) %>% 
  column_to_rownames("sample_component") 

plot_legend <- max(abs(range(plot_data)))
BT_segregation_heatmap <- 
  plot_data %>% 
  pheatmap(cutree_rows = 2,
           color = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(101),
           breaks = seq(-plot_legend, plot_legend, length.out = 102),
           cellwidth = 10,
           show_rownames = F)

ggsave("results/unstimulated/gated BT segregation heatmap.png",
       plot = as.ggplot(BT_segregation_heatmap),
       width = 9, height = 9)
ggsave("results/unstimulated/gated BT segregation heatmap.pdf",
       plot = as.ggplot(BT_segregation_heatmap),
       width = 9, height = 9)





expand_grid(marker_1 = c(some_T_markers),
            marker_2 = c(some_B_markers)) %>% 
  left_join(GetAssayData(BT_filtered_data, slot = "data") %>% 
              t() %>% 
              as_tibble(rownames = "sample_component") %>% 
              gather(marker, clr, -1),
            by = c("marker_1" = "marker")) %>% 
  left_join(GetAssayData(BT_filtered_data, slot = "data") %>% 
              t() %>% 
              as_tibble(rownames = "sample_component") %>% 
              gather(marker, clr, -1),
            by = c("sample_component", "marker_2" = "marker"),
            suffix = c("1", "2")) %>% 
  filter(complete.cases(.)) %>% 
  left_join(BT_segregation_heatmap$tree_row %>% 
              cutree(2) %>% 
              enframe("sample_component", "doublet") %>% 
              mutate(doublet_type = ifelse(doublet == 2,
                                           "BT doublet", 
                                           "Not BT doublet"))) %>% 
  ggplot(aes(clr1, clr2, color = doublet_type)) +
  geom_point(size = 0.3) +
  # scale_color_gradient2(low = "skyblue3", mid = "gray90", high = "orangered") +
  facet_grid(marker_2 ~ marker_1, scales = "free") +
  theme_bw()

ggsave("results/unstimulated/gated BT doublet scatter class.png",
       width = 9, height = 4)
ggsave("results/unstimulated/gated BT doublet scatter class.pdf",
       width = 9, height = 4)



pg_data_comb_processed@reductions$umap@cell.embeddings %>% 
  as_tibble(rownames = "sample_component") %>% 
  left_join(BT_segregation_heatmap$tree_row %>% 
              cutree(2) %>% 
              enframe("sample_component", "doublet") %>% 
              mutate(doublet_type = ifelse(doublet == 2,
                                           "BT doublet", 
                                           "Not BT doublet"))) %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = doublet_type)) +
  geom_point() +
  coord_fixed() +
  theme_bw()



plot_data <- 
  pg_data_comb_processed[[]] %>% 
  as_tibble(rownames = "sample_component") %>% 
  select(1, edges, upia) %>% 
  gather(var, value, -1) %>% 
  left_join(BT_segregation_heatmap$tree_row %>% 
              cutree(2) %>% 
              enframe("sample_component", "doublet") %>% 
              mutate(doublet_type = ifelse(doublet == 2,
                                           "BT doublet", 
                                           "Not BT doublet"))) %>% 
  filter(!is.na(doublet_type)) 

plot_data %>% 
  ggplot(aes(doublet_type, value)) +
  geom_violin(draw_quantiles = 0.5) +
  ggbeeswarm::geom_beeswarm(cex = 1,
                            size = 0.1) +
  stat_compare_means(method = "wilcox", 
                     comparisons = list(c("BT doublet", "Not BT doublet"))) +
  facet_wrap(~ var, scale = "free_y") +
  scale_y_log10(expand = expansion(c(0, 0.1))) +
  theme_bw() +
  theme(panel.grid = element_blank())


ggsave("results/unstimulated/gated BT doublet size comparison.png",
       width = 5, height = 3)
ggsave("results/unstimulated/gated BT doublet size comparison.pdf",
       width = 5, height = 3)

plot_data %>% 
  group_by(doublet_type, var) %>% 
  summarise(median = median(value)) %>% 
  spread(doublet_type, median) %>% 
  mutate(ratio = `BT doublet` / `Not BT doublet`)


plot_data <- 
  expand_grid(marker_1 = c(some_B_markers, some_T_markers),
              marker_2 = c(some_B_markers, some_T_markers))  %>% 
  left_join(colocalization_scores %>% 
              filter(marker_1 %in% c(some_B_markers, some_T_markers),
                     marker_2 %in% c(some_B_markers, some_T_markers)) %>% 
              mutate(temp_marker = ifelse(marker_2 %in% some_T_markers,
                                          marker_1,
                                          marker_2),
                     marker_1_orig = marker_1,
                     marker_2_orig = marker_2,
                     marker_1 = ifelse(marker_1 %in% some_T_markers,
                                       marker_1,
                                       marker_2),
                     marker_2 = ifelse(marker_2 %in% some_T_markers,
                                       temp_marker,
                                       marker_2))) %>% 
  left_join(BT_segregation_heatmap$tree_row %>% 
              cutree(2) %>% 
              enframe("sample_component", "doublet") %>% 
              mutate(doublet_type = ifelse(doublet == 2,
                                           "BT doublet", 
                                           "Not BT doublet"))) %>% 
  # select(marker_1, marker_2, temp_marker) %>% distinct
  unite(contrast, marker_1, marker_2, sep = "/", remove = F) %>% 
  mutate(marker_1 = factor(marker_1, some_T_markers),
         marker_2 = factor(marker_2, some_B_markers)) %>% 
  filter(complete.cases(.)) 

plot_data %>% 
  ggplot(aes(doublet_type, pearson_z)) +
  geom_violin(draw_quantiles = 0.5) +
  ggbeeswarm::geom_beeswarm(cex = 1,
                            size = 0.1) +
  facet_grid(marker_2 ~ marker_1) +
  theme_bw()
  
plot_data %>% 
  group_by(contrast, doublet_type) %>% 
  summarise(median = median(pearson_z)) %>% 
  ungroup() %>% 
  mutate(contrast = factor(contrast, 
                           filter(., doublet_type == "BT doublet") %>% 
                             arrange(median) %>% 
                             pull(contrast))) %>% 
  ggplot(aes(doublet_type, contrast, fill = median, label = round(median, 1))) +
  geom_tile() +
  geom_text(size = 3) +
  scale_fill_gradient(low = "orangered", high = "gray95") +
  scale_x_discrete(expand = expansion(0)) +
  scale_y_discrete(expand = expansion(0)) +
  coord_fixed() +
  theme_bw() +
  theme(axis.text.x = element_text(hjust = 1, angle = 60))

ggsave("results/unstimulated/gated BT median coloc.png",
       width = 5, height = 5)
ggsave("results/unstimulated/gated BT median coloc.pdf",
       width = 5, height = 5)

```


### Visualized

```{r}
### Generate Kk layouts:
potential_BT_doublets <- 
  BT_segregation_heatmap$tree_row %>% 
  cutree(2) %>% 
  enframe("sample_component", "doublet") %>%
  filter(doublet == 2)

potential_BT_doublets %>% 
  pull(1) %>% 
  paste(collapse = '",\n"') %>% 
  paste0('c("', ., '")') %>% 
  cat()


library(multidplyr)

cluster <- new_cluster(5)
cluster_library(cluster, 
                c("dplyr",
                  "tidyr",
                  "tibble"))
cluster_copy(cluster, 
             c("get_component_layout",
               "create_node_markers_counts",
               "edgelist_to_simple_Anode_graph",
               "edgelist_to_simple_bipart_graph",
               "map",
               "write_rds"))

edgelists %>%
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  filter(sample_component %in% potential_BT_doublets$sample_component) %>% 
  group_by(sample_component) %>% 
  partition(cluster) %>% 
  do({
    comp <- .
    
    comp_name <- unique(comp$sample_component)
    
    component_path <- paste0("data/layouts/unstim_kkweighted_3D_", comp_name, ".rds")
    if(!file.exists(component_path)) {
      
      layt <- 
        comp %>% 
        get_component_layout(layout_method = "kk", dim = 3, weighted = T) 
      
      write_rds(layt, component_path)
    }
    
    tibble()
  }) %>% 
  collect()

edgelists %>%
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  filter(sample_component %in% potential_BT_doublets$sample_component) %>% 
  group_by(sample_component) %>% 
  partition(cluster) %>% 
  do({
    comp <- .
    
    comp_name <- unique(comp$sample_component)
    
    component_path <- paste0("data/layouts/unstim_pmds_3D_", comp_name, ".rds")
    if(!file.exists(component_path)) {
      
      layt <- 
        comp %>% 
        get_component_layout(layout_method = "pmds", dim = 3, pivots = 100, weighted = F) 
      
      write_rds(layt, component_path)
    }
    
    tibble()
  }) %>% 
  collect()

edgelists %>%
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  filter(sample_component %in% potential_BT_doublets$sample_component) %>% 
  group_by(sample_component) %>% 
  partition(cluster) %>% 
  do({
    comp <- .
    
    comp_name <- unique(comp$sample_component)
    
    component_path <- paste0("data/layouts/unstim_kk_3D_", comp_name, ".rds")
    if(!file.exists(component_path)) {
      
      layt <- 
        comp %>% 
        get_component_layout(layout_method = "kk", dim = 3, weighted = F) 
      
      write_rds(layt, component_path)
    }
    
    tibble()
  }) %>% 
  collect()

rm(cluster)


component_3Dlayouts_BT_pmds <-
  potential_BT_doublets$sample_component %>% 
  set_names(., .) %>% # Set names of vector to get named output list
  pblapply(function(comp) {
    component_path <- paste0("data/layouts/unstim_pmds_3D_", comp, ".rds")

    layt <- read_rds(component_path)

    layt$graph <- NA

    return(layt)

  })


plot_counts <- 
  component_3Dlayouts_BT_pmds %>% 
  map(. %>% 
        {.$upi_counts} %>% 
        as_tibble(rownames = "upi") %>% 
        gather(marker, count, -1)) %>% 
  bind_rows(.id = "sample_component") 

plot_comps_data <- 
  component_3Dlayouts_BT_pmds %>% 
  map(. %>% 
        {.$layout}) %>% 
  bind_rows(.id = "sample_component") %>%
  filter(node_type == "A") %>% 
  arrange(z) %>% 
  left_join(plot_counts) 

plot_comps_data %>% 
  filter(marker %in% c("CD3E", "CD4", "CD8", "CD45", "CD20", "CD19")) %>% 
  filter(count > 0) %>% 
  ggplot(aes(x, y, color = log1p(count))) +
  geom_point(size = 0.7) +
  coord_fixed() +
  facet_grid(marker~ sample_component) +
  scale_color_gradient(low = "gray80", high = "orangered") +
  theme_minimal()


plot_comps_data %>% 
  filter(sample_component == names(component_3Dlayouts_BT_pmds)[1]) %>% 
  mutate(marker = ifelse(marker %in% c("CD20", "CD3E"),
                         marker,
                         "Other")) %>% 
  group_by(marker, upi, x, y, z) %>% 
  summarise(count = ifelse(marker == "Other", 
                           0, 
                           sum(count))) %>% 
  distinct() %>% 
  filter(count != 0 | marker == "Other") %>% 
  group_by(upi) %>% 
  filter(!(marker == "Other" & any(marker != "Other"))) %>% 
  arrange(upi) %>% 
  # filter(count > 0) %>% 
  plot_ly(x = ~.$x,
          y = ~.$y,
          z = ~.$z,
          color = ~.$marker,
          size = ~ .$count,
          sizes = 70*c(1, 10),
          colors = c("Other" = "gray",
                     "CD20" = "skyblue",
                     "CD3E" = "orangered"))


# 


some_markers <- 
  c("CD3E", "CD4", "CD8", "CD45", "CD20", "CD19")


plot_data <- 
  plot_comps_data %>% 
  filter(marker %in% some_markers) %>% 
  mutate(xbin = cut(x, breaks = seq(-1, 1, length.out = 20)),
         ybin = cut(y, breaks = seq(-1, 1, length.out = 20))) %>% 
  group_by(sample_component, xbin, ybin, marker) %>% 
  summarise(count = sum(count)) %>% 
  spread(marker, count, fill = 0) %>% 
  gather(marker, count, -c(1:4)) %>% 
  ungroup() %>% 
  mutate(marker = factor(marker, some_markers)) %>% 
  group_by(sample_component, xbin, ybin) %>% 
  mutate(total_bincount = sum(count)) 

# plot <- 
  plot_data %>% 
  ggplot(aes(xbin, ybin, fill = log10(count + 1), color = log10(count + 1))) +
  geom_tile() +
  facet_grid(marker ~ sample_component) +
  scale_fill_viridis() +
  scale_color_viridis() +
  coord_fixed() +
  theme_void()
# ggsave("results/unstimulated/Monoplat visualized binned.png",
#        plot = plot,
#        width = 45, height = 10)
# ggsave("results/unstimulated/Monoplat visualized binned.pdf",
#        plot = plot,
#        width = 45, height = 10)
```


#### Aligned and normed layouts

```{r}

plot_counts <- 
  component_3Dlayouts_BT_pmds %>% 
  map(. %>% 
        {.$upi_counts} %>% 
        as_tibble(rownames = "upi") %>% 
        gather(marker, count, -1)) %>% 
  bind_rows(.id = "sample_component") 

plot_layouts <- 
  component_3Dlayouts_BT_pmds %>% 
  map(. %>% 
        {.$layout}) %>% 
  bind_rows(.id = "sample_component") 

# plot_layouts_normcoords <- 
#   plot_layouts %>% 
#   select(sample_component, upi, node_type, x, y, z) %>% 
#   distinct() %>%
#   mutate(norm_factor = 
#            select(., x, y, z) %>% 
#            apply(MARGIN = 1, function(x) {
#              as.matrix(x) %>% 
#                norm(type = "F")
#            }),
#          x = x / norm_factor,
#          y = y / norm_factor,
#          z = z / norm_factor) %>% 
#   arrange(z) 

procrustes_data <- 
  plot_layouts %>% 
  left_join(plot_counts) %>%
  rename(component = sample_component) %>% 
  group_split(component) 

procrustes_reference <- 
  procrustes_data %>% 
  map(. %>% 
        select(component) %>% 
        distinct()) %>% 
    unlist() %>% 
    {which(. == "S2_RCVCMP0000094")}

plot_layouts_aligned <- 
  procrustes_data %>% 
  procrustes_align(anchor_markers = c("CD45", "HLA-ABC", "B2M",
                                      "CD20", "CD40", "CD19",
                                      "CD3E", "CD2", "CD5"), 
                   reference = procrustes_reference,
                   do_scale = T) 


# some_markers <- 
#   c("CD45", "HLA-ABC", "B2M",
#     "CD20", "CD40", "CD19",
#     "CD3E", "CD2", "CD5",
#     "CD4", "CD8")
  
some_markers <- 
  c("CD45",
    "CD20", "CD19",
    "CD3E", "CD2",
    "CD4", "CD8")

plot_comps_data <- 
  plot_layouts_aligned %>% 
  bind_rows(.id = "sample_component") 


plot_comps_data %>% 
  filter(node_type == "A") %>% 
  filter(marker %in% some_markers) %>% 
  mutate(marker = factor(marker, some_markers)) %>% 
  arrange(-z_rot) %>% 
  filter(count > 0) %>% 
  ggplot(aes(x_rot, y_rot, color = log1p(count), size = -z_rot)) +
  geom_point() +
  coord_fixed() +
  facet_grid(sample_component ~ marker) +
  scale_color_viridis() +
  scale_size_continuous(range = c(0.3, 2)) +
  theme_minimal()



plot_data <-
  plot_comps_data %>% 
  filter(node_type == "A") %>% 
  filter(marker %in% some_markers) %>% 
  group_by(sample_component) %>% 
  mutate(x_rot = scales::rescale(x_rot, c(-1, 1)), # Center the component again after alignment
         y_rot = scales::rescale(y_rot, c(-1, 1))) %>% 
  mutate(xbin = cut(x_rot, breaks = seq(-1, 1, length.out = 20)),
         ybin = cut(y_rot, breaks = seq(-1, 1, length.out = 20))) %>% 
  group_by(sample_component, xbin, ybin, marker) %>% 
  summarise(count = sum(count)) %>% 
  spread(marker, count, fill = 0) %>% 
  gather(marker, count, -c(1:3)) %>% 
  ungroup() %>% 
  mutate(marker = factor(marker, some_markers)) %>% 
  group_by(sample_component, xbin, ybin) %>% 
  mutate(total_bincount = sum(count)) 

# plot <- 
#   plot_data %>% 
#   mutate(sample_component = str_remove(sample_component, "RCVCMP0000")) %>% 
#   ggplot(aes(xbin, ybin, fill = log10(count + 1), color = log10(count + 1))) +
#   geom_tile() +
#   facet_grid(marker ~ sample_component) +
#   scale_fill_viridis() +
#   scale_color_viridis() +
#   coord_fixed() +
#   theme_void()
# ggsave("results/unstimulated/BT visualized aligned binned.png",
#        plot = plot,
#        width = 45, height = 10)
# ggsave("results/unstimulated/BT visualized aligned binned.pdf",
#        plot = plot,
#        width = 45, height = 10)

# plot <- 
plot_data %>% 
  mutate(sample_component = str_remove(sample_component, "RCVCMP0000")) %>% 
  group_by(sample_component) %>% 
  mutate(count = log10(count + 1), 
         color = count / max(c(count, 1))) %>% 
  ggplot(aes(xbin, ybin, fill = color, color = color)) +
  geom_tile() +
  facet_grid(marker ~ sample_component) +
  scale_fill_gradientn(colours = ggsci::pal_material(palette = "blue-grey")(10))+#c("gray95", "mistyrose", "red", "darkred")) +
  scale_color_gradientn(colours = ggsci::pal_material(palette = "blue-grey")(10)) + #c("gray95", "mistyrose", "red", "darkred")) +
  coord_fixed() +
  theme_void()
ggsave("results/unstimulated/BT visualized aligned binned examples.png",
       width = 10, height = 10)
ggsave("results/unstimulated/BT visualized aligned binned examples.pdf",
       width = 10, height = 10)


```


#### Visualise BT doublets

```{r}


plot_data <-
  plot_comps_data %>% 
  filter(node_type == "A") %>% 
  filter(marker %in% some_markers) %>% 
  group_by(sample_component) %>% 
  mutate(x_rot = scales::rescale(x_rot, c(-1, 1)), # Center the component again after alignment
         y_rot = scales::rescale(y_rot, c(-1, 1))) %>% 
  mutate(xbin = cut(x_rot, breaks = seq(-1, 1, length.out = 20)),
         ybin = cut(y_rot, breaks = seq(-1, 1, length.out = 20))) %>% 
  group_by(sample_component, xbin, ybin, marker) %>% 
  summarise(count = sum(count)) %>% 
  spread(marker, count, fill = 0) %>% 
  gather(marker, count, -c(1:3)) %>% 
  ungroup() %>% 
  mutate(marker = factor(marker, some_markers)) %>% 
  group_by(sample_component, xbin, ybin) %>% 
  mutate(total_bincount = sum(count)) 



plot_comps_data %>% 
  filter(node_type == "A") %>% 
  filter(marker %in% c(some_B_markers,
                       some_T_markers)) %>%
  mutate(marker = ifelse(marker %in% some_B_markers,
                         "B cell", 
                         "T cell")) %>% 
  group_by(sample_component, component, upi, marker, 
           x_rot, y_rot, z_rot) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(count = log10(count + 1)) %>% 
  spread(marker, count) %>% 
  # filter(sample_component %in% unique(sample_component)[1:6]) %>%
  group_by(sample_component) %>% 
  mutate(`B cell` = `B cell` / max(`B cell`),
         `T cell` = `T cell` / max(`T cell`)) %>% 
  mutate(color = 
           rgb(red = `B cell`,
               green = `T cell`, 
               blue = (`B cell`+`T cell`)/5, 
               maxColorValue = 1)) %>% 
  arrange(z_rot) %>% 
  ggplot(aes(x_rot, y_rot, color = color, 
             size = `B cell` + `T cell`)) +
  geom_point(alpha = 0.75) +
  # scale_color_gradient2(low = "#236F9A", mid = "gray", high = "#E52100")
  facet_wrap(~sample_component) +
  scale_color_identity() +
  scale_size_continuous(range = c(0.1, 4)) +
  coord_fixed() +
  theme_void()

expand_grid(x = seq(0, 1, length.out = 50),
            y = seq(0, 1, length.out = 50)) %>% 
  mutate(color = 
           rgb(red = y,
               green = x, 
               blue = (y+x)/4,
               maxColorValue = 1)) %>% 
  ggplot(aes(x, y, fill = color, color = color)) +
  geom_tile() +
  scale_fill_identity() +
  scale_color_identity() +
  coord_fixed() +
  theme_void()



#####


plot_edgelist <- 
  edgelists %>% 
  map(. %>% 
        filter(component %in% str_remove(potential_BT_doublets$sample_component, ".*_")))  %>% 
  bind_rows(.id = "sample") %>% 
  unite(sample_component, sample, component) %>% 
  filter(sample_component %in% potential_BT_doublets$sample_component) %>% 
  select(upia, upib, sample_component) %>% 
  distinct()

plot_coloring <-
  plot_comps_data %>% 
  filter(node_type == "A") %>% 
  filter(marker %in% c(some_B_markers,
                       some_T_markers)) %>%
  mutate(marker = ifelse(marker %in% some_B_markers,
                         "B cell", 
                         "T cell")) %>% 
  group_by(sample_component, component, upi, marker) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(count = log10(count + 1)) %>% 
  
  spread(marker, count) %>% 
  # filter(sample_component %in% unique(sample_component)[1:6]) %>%
  group_by(sample_component) %>% 
  mutate(`B cell` = `B cell` / max(`B cell`),
         `T cell` = `T cell` / max(`T cell`)) %>% 
  mutate(color = 
           rgb(red = `B cell`,
               green = `T cell`, 
               blue = (`B cell`+`T cell`)/5, 
               maxColorValue = 1)) 

plot_coords <-
  plot_comps_data %>% 
  select(sample_component, upi, node_type, 
         x_rot, y_rot, z_rot) %>% 
  distinct()

plot <-
  plot_edgelist %>% 
  mutate(upia = paste(upia, sample_component),
         upib = paste(upib, sample_component)) %>% 
  distinct() %>% 
  # filter(sample_component == sample_component[1]) %>%
  as_tbl_graph(directed = F) %>% 
  mutate(sample_component = str_remove(name, ".* "),
         upi = str_remove(name, " .*")) %>% 
  left_join(plot_coloring) %>% 
  left_join(plot_coords) %>%
  rename(x = x_rot,
         y = y_rot,
         z = z_rot) %>%
  mutate(size = case_when(z < -1 ~ -1,
                          z > 1 ~ 1,
                          T ~ z)) %>% 
  ggraph(layout = "manual", 
         x = as_tibble(.)$x,
         y = as_tibble(.)$y) +
  geom_node_point(data = . %>%
                    filter(z < 0) %>%
                    arrange(z),
                  aes(size = z,
                      color = color,
                      alpha = `B cell` + `T cell` > 0)) +
  geom_edge_link(color = "gray30",
                 alpha = 0.3,
                 width = 0.1) +
  geom_node_point(data = . %>% 
                    filter(z >= 0) %>% 
                    arrange(z), 
                  aes(size = z,
                      color = color,
                      alpha = `B cell` + `T cell` > 0)) +
  facet_wrap(~ sample_component) +
  scale_size_continuous(range = c(0.5, 4)) +
  scale_color_identity() +
  scale_alpha_manual(values = c("TRUE" = 0.8, "FALSE" = 0.1)) +
  coord_fixed() +
  theme_void() +
  theme(panel.background = element_rect(fill = "white"))
ggsave("results/unstimulated/BT doublet visualized.png",
       plot = plot,
       width = 24, height = 24)
ggsave("results/unstimulated/BT doublet visualized.pdf",
       plot = plot,
       width = 24, height = 24)



plot <-
  plot_edgelist %>% 
  mutate(upia = paste(upia, sample_component),
         upib = paste(upib, sample_component)) %>% 
  distinct() %>% 
  filter(sample_component %in% c("S1_RCVCMP0000578",
                                 "S2_RCVCMP0000030",
                                 "S2_RCVCMP0000108",
                                 "S2_RCVCMP0000104")) %>%
  as_tbl_graph(directed = F) %>% 
  mutate(sample_component = str_remove(name, ".* "),
         upi = str_remove(name, " .*")) %>% 
  left_join(plot_coloring) %>% 
  left_join(plot_coords) %>%
  rename(x = x_rot,
         y = y_rot,
         z = z_rot) %>%
  mutate(size = case_when(z < -1 ~ -1,
                          z > 1 ~ 1,
                          T ~ z)) %>% 
  ggraph(layout = "manual", 
         x = as_tibble(.)$x,
         y = as_tibble(.)$y) +
  geom_node_point(data = . %>%
                    filter(z < 0) %>%
                    arrange(z),
                  aes(size = size,
                      color = color,
                      alpha = `B cell` + `T cell` > 0)) +
  geom_edge_link(color = "gray30",
                 alpha = 0.3,
                 width = 0.1) +
  geom_node_point(data = . %>% 
                    filter(z >= 0) %>% 
                    arrange(z), 
                  aes(size = size,
                      color = color,
                      alpha = `B cell` + `T cell` > 0)) +
  facet_wrap(~ sample_component) +
  scale_size_continuous(range = c(0.5, 4)) +
  scale_color_identity() +
  scale_alpha_manual(values = c("TRUE" = 0.8, "FALSE" = 0.1)) +
  coord_fixed() +
  theme_void() +
  theme(panel.background = element_rect(fill = "white"))
ggsave("results/unstimulated/BT doublet visualized few.png",
       plot = plot,
       width = 12, height = 12)
ggsave("results/unstimulated/BT doublet visualized few.pdf",
       plot = plot,
       width = 12, height = 12)



expand_grid(x = seq(0, 1, length.out = 50),
            y = seq(0, 1, length.out = 50)) %>% 
  mutate(color = 
           rgb(red = y,
               green = x, 
               blue = (y+x)/5,
               maxColorValue = 1)) %>% 
  ggplot(aes(x, y, fill = color, color = color)) +
  geom_tile() +
  scale_fill_identity() +
  scale_color_identity() +
  scale_x_continuous(breaks = 0:1, expand = expansion(0)) +
  scale_y_continuous(breaks = 0:1, expand = expansion(0)) +
  coord_fixed() +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank())
ggsave("results/unstimulated/BT doublet legend.png",
       width = 2, height = 2)
ggsave("results/unstimulated/BT doublet legend.pdf",
       width = 2, height = 2)

```


#### 2D density

```{r}
# 2D Density plots

plot_data_density <- 
  plot_comps_data %>% 
  filter(count > 0) %>%
  group_by_all() %>% 
  summarise(i = rep(1, count)) %>% 
  group_by(sample_component, marker) %>% 
  do({
    get_density(.$y_rot, .$x_rot, h = 0.3, n = 40)
  }) 


plot_data_density_null <- 
  plot_comps_data %>% 
  group_by(sample_component, upi, x_rot, y_rot) %>% 
  summarise(count = sum(count)) %>% 
  group_by(sample_component) %>% 
  do({
    get_density(.$y_rot, .$x_rot, h = 0.3, n = 40)
  }) 




plot_data <- 
  plot_data_density %>% 
  filter(marker %in% some_markers) %>% 
  mutate(marker = factor(marker, c(some_markers))) 

# plot_hulls <- 
#   plot_data_density_null %>% 
#   filter(sample_component %in% plot_data$sample_component) %>% 
#   group_by(sample_component) %>% 
#   mutate(normalized_density = density / sum(density)) %>% 
#   arrange(-normalized_density) %>% 
#   mutate(cum_density = cumsum(normalized_density)) %>% 
#   filter(cum_density <= 0.99) %>% 
#   group_by(sample_component) %>%
#   do({select(., x, y) %>% 
#       as.matrix() %>% 
#       concaveman::concaveman(concavity = 2) %>% 
#       as_tibble() %>% 
#       rename(x = V1, 
#              y = V2)}) %>% 
#   ungroup() %>% 
#   left_join(PMA_category)



plot_data%>% 
  group_by(sample_component, marker) %>% 
  # mutate(density = scales::rescale(density, 0:1)) %>% 
  ggplot(aes(x, y, fill = density)) +
  geom_tile() +
  # geom_polygon(data = plot_hulls,
  #              aes(x, y),
  #              inherit.aes = F,
  #              color = "white",
  #              alpha = 0.1) +
  facet_grid(marker ~ sample_component) +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()

plot_data %>% 
  left_join(plot_data_density_null,
            by = c("sample_component", "x", "y"), 
            suffix = c("", "_null")) %>% 
  filter(marker == "CD3E", 
         sample_component == "S2_RCVCMP0000094") %>% 
  ggplot(aes(density, density_null)) +
  geom_point()

plot_data %>% 
  left_join(plot_data_density_null,
            by = c("sample_component", "x", "y"), 
            suffix = c("", "_null")) %>% 
  mutate(marker = factor(marker, c(some_markers))) %>%
  group_by(sample_component, marker) %>% 
  mutate(density_diff = density - density_null,
         normalized_density_diff = density_diff / max(abs(density_diff))) %>% 
  ungroup() %>% 
  ggplot(aes(x, y, fill = normalized_density_diff)) +
  geom_tile() +
  facet_grid(marker ~ sample_component) +
  scale_fill_gradient2(high = "red", mid = "black", low = "green") +
  coord_fixed() +
  theme_void()



plot_data %>% 
  select(-count) %>% 
  group_by(sample_component, marker) %>% 
  mutate(density = density / sum(density)) %>% 

  spread(marker, density) %>% 
  ggplot(aes(x, y, fill = CD3E - CD20)) +
  geom_tile() +
  facet_grid( ~ sample_component) +
  scale_fill_gradient2(high = "red", mid = "black", low = "green") +
  coord_fixed() +
  theme_void()


plot_data %>% 
  select(-count) %>% 
  left_join(plot_data_density_null,
            by = c("sample_component", "x", "y"), 
            suffix = c("", "_null")) %>% 
  group_by(sample_component, marker) %>% 
  mutate(density = density / sum(density),
         density_null = density_null / sum(density_null),
         # density = density - density_null,
         # density = ifelse(density < 0, 0, density),
         density = scales::rescale(density, 0:1)
         ) %>% 

  spread(marker, density) %>% 
  mutate(color = 
           rgb(red = CD3E,
               green = CD20, 
               blue = 0,
               maxColorValue = max(c(CD3E, CD20)))) %>% 
  ggplot(aes(x, y, fill = color)) +
  geom_tile() +
  facet_grid( ~ sample_component) +
  scale_fill_identity() +
  coord_fixed() +
  theme_void()


plot_data%>% 
  group_by(sample_component, marker) %>%
  mutate(density = scales::rescale(count*density, 0:1)) %>%
  select(-count) %>% 
  spread(marker, density, fill = 0) %>% 
  mutate(sample_component = str_remove(sample_component, "RCVCMP000"))  %>% 
  ggplot(aes(x, y, fill = CD3E - CD20)) +
  geom_tile() +
  # geom_polygon(data = plot_hulls,
  #              aes(x, y),
  #              inherit.aes = F,
  #              color = "white",
  #              alpha = 0.1) +
  facet_grid( ~ sample_component) +
  # scale_fill_viridis() +
  scale_fill_gradient2(high = "orangered3", mid = "white", low = "skyblue3") +
  coord_fixed() +
  theme_void()

####################################




plot_data



```



## Full data heatmap

Here we just plot a heatmap of the abundance of all measured markers

```{r}

plot_data <- 
  pg_data_comb_processed@assays$RNA@data[,component_identities$sample_component] %>% 
  as.matrix() %>% 
  t() 
  # sweep(1, apply(., 1, sum), "/") %>% 
  # `*`(1e4) %>% 
  # {log10(. + 1)} 

plot_meta <- 
  component_identities %>% 
  filter(sample_component %in% rownames(plot_data)) %>% 
  select(sample_component, sample, cell_type_name) %>% 
  column_to_rownames("sample_component")

plot_heatmap <- 
  plot_data %>% 
  pheatmap(color = inferno(20),
           border_color = NA,
           clustering_method = "ward.D2",
           annotation_row = plot_meta, 
           annotation_colors = list(cell_type_name = cell_palette),
           show_rownames = F,
           cutree_rows = 7,
           cellwidth = 10,
           cellheight = 0.65) %>% 
  as.ggplot()
ggsave("results/unstimulated/cell abundance heatmap.png",
       plot = plot_heatmap, 
       width = 16, height = 12)  
ggsave("results/unstimulated/cell abundance heatmap.pdf",
       plot = plot_heatmap,
       width = 16, height = 12)  



```


